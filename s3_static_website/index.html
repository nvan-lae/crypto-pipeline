<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My DynamoDB Crypto History</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        h1 { margin-bottom: 20px; }
        .chart-container {
            position: relative;
            width: 90%;
            max-width: 800px;
            background: #2c2c2c;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        #error-msg {
            color: #ff6b6b;
            display: none;
            margin-bottom: 10px;
            background: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <h1>DynamoDB History</h1>
    
    <div id="error-msg"></div>

    <div class="chart-container">
        <canvas id="historyChart"></canvas>
    </div>

    <script>
        const apiUrl = 'https://s2x9o7rca4.execute-api.eu-west-3.amazonaws.com/prod/data';

        async function loadData() {
            try {
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }

                const rawData = await response.json();
                console.log("DynamoDB Response:", rawData); 

                let dataArray = [];
                
                if (Array.isArray(rawData)) {
                    dataArray = rawData;
                } else if (rawData.Items && Array.isArray(rawData.Items)) {
                    dataArray = rawData.Items;
                } else if (rawData.body) {
                    try {
                        const parsedBody = JSON.parse(rawData.body);
                        dataArray = Array.isArray(parsedBody) ? parsedBody : (parsedBody.Items || []);
                    } catch(e) {
                        dataArray = rawData.body;
                    }
                }

                if (!Array.isArray(dataArray) || dataArray.length === 0) {
                    throw new Error("Found no data array. Check console log for structure.");
                }
 
                dataArray.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                const labels = dataArray.map(item => {
                
                    return new Date(item.timestamp).toLocaleTimeString(); 
                });

                const prices = dataArray.map(item => {
               
                    return item.price; 
                });

                renderChart(labels, prices);

            } catch (error) {
                console.error("Full Error Details:", error);
                const errDiv = document.getElementById('error-msg');
                errDiv.style.display = 'block';
                errDiv.innerText = "Failed to load history: " + error.message;
            }
        }

        let myChart;

        function renderChart(labels, dataPoints) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price History',
                        data: dataPoints,
                        borderColor: '#4bc0c0',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            ticks: { color: '#ddd' },
                            grid: { color: '#444' }
                        },
                        x: {
                            ticks: { color: '#ddd' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    }
                }
            });
        }

        loadData();
    </script>
</body>
</html>
